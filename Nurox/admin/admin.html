<!DOCTYPE html>
<html>
<head>
<title>NUROX Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#0f172a,#020617);color:#e2e8f0;min-height:100vh;}

/* LOGIN */
.login-wrap{max-width:400px;margin:120px auto;padding:0 20px;}
.login-box{background:rgba(30,41,59,0.95);padding:40px;border-radius:20px;border:1px solid #1e293b;}
.login-box h2{font-size:22px;font-weight:800;margin-bottom:6px;}
.login-box p{font-size:13px;color:#94a3b8;margin-bottom:24px;}
.login-box input{width:100%;padding:12px 16px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:white;font-size:14px;margin-bottom:12px;outline:none;}
.login-box input:focus{border-color:#ef4444;}
.btn{padding:12px 24px;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px;transition:0.2s;}
.btn:hover{opacity:0.85;}
.btn-red{background:linear-gradient(135deg,#ef4444,#dc2626);color:white;width:100%;}
.btn-green{background:linear-gradient(135deg,#22c55e,#16a34a);color:white;}
.btn-blue{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;}
.btn-yellow{background:linear-gradient(135deg,#f59e0b,#d97706);color:white;}
.btn-gray{background:#334155;color:#e2e8f0;}
.btn-sm{padding:7px 16px;font-size:13px;}
.err{color:#f87171;font-size:13px;margin-top:10px;text-align:center;}

/* MAIN LAYOUT */
.topbar{background:rgba(15,23,42,0.98);padding:14px 32px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1e293b;position:sticky;top:0;z-index:100;}
.topbar-left{display:flex;align-items:center;gap:12px;}
.topbar h1{font-size:18px;font-weight:800;}
.admin-badge{background:#ef4444;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.container{max-width:1200px;margin:auto;padding:32px 20px;}

/* STAT CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:32px;}
.stat-card{background:rgba(30,41,59,0.85);padding:22px;border-radius:14px;border-left:4px solid #22c55e;}
.stat-card.red{border-left-color:#ef4444;}
.stat-card.blue{border-left-color:#3b82f6;}
.stat-card.purple{border-left-color:#a855f7;}
.stat-label{font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.stat-value{font-size:30px;font-weight:800;}

/* SECTION */
.section{background:rgba(30,41,59,0.85);border-radius:16px;padding:24px;margin-bottom:24px;}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.section-title{font-size:16px;font-weight:700;}

/* TABLE */
table{width:100%;border-collapse:collapse;}
th{padding:12px 16px;text-align:left;font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid #1e293b;}
td{padding:14px 16px;font-size:14px;border-bottom:1px solid #1e293b;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,0.02);}
.plan-badge{padding:3px 12px;border-radius:20px;font-size:12px;font-weight:700;display:inline-block;}
.plan-free{background:#1e3a8a;color:#93c5fd;}
.plan-pro{background:#14532d;color:#86efac;}
.plan-enterprise{background:#4c1d95;color:#c4b5fd;}
.status-active{color:#22c55e;font-weight:600;}
.status-disabled{color:#ef4444;font-weight:600;}
.actions{display:flex;gap:8px;flex-wrap:wrap;}

/* UPGRADE FORM */
.form-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
.form-row input, .form-row select{padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:white;font-size:14px;outline:none;flex:1;min-width:140px;}
.form-row input:focus, .form-row select:focus{border-color:#22c55e;}

/* TOAST */
.toast{position:fixed;bottom:30px;right:30px;background:#1e293b;border:1px solid #334155;padding:14px 20px;border-radius:12px;font-size:14px;font-weight:600;z-index:999;display:none;max-width:320px;}
.toast.show{display:block;animation:fadeIn 0.3s;}
.toast.success{border-color:#22c55e;color:#22c55e;}
.toast.error{border-color:#ef4444;color:#ef4444;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

.hidden{display:none;}
.loading{color:#94a3b8;font-size:14px;padding:20px 0;text-align:center;}
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-wrap">
    <div class="login-box">
      <h2>üîê Admin Panel</h2>
      <p>NUROX restricted access only</p>
      <input id="adminUser" type="text" placeholder="Admin Username" />
      <input id="adminPass" type="password" placeholder="Admin Password" />
      <button class="btn btn-red" onclick="doAdminLogin()">Access Panel</button>
      <div class="err" id="loginErr"></div>
    </div>
  </div>
</div>

<!-- MAIN PANEL -->
<div id="mainPanel" class="hidden">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üöÄ NUROX</h1>
      <span class="admin-badge">ADMIN</span>
    </div>
    <button class="btn btn-gray btn-sm" onclick="doLogout()">Logout</button>
  </div>

  <div class="container">

    <!-- STATS -->
    <div class="stats-grid" id="statsGrid">
      <div class="loading">Loading stats...</div>
    </div>

    <!-- UPGRADE USER -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">‚ö° Manage User Plan</div>
      </div>
      <div class="form-row">
        <input id="upgradeUsername" type="text" placeholder="Username" />
        <select id="upgradePlan">
          <option value="free">Free</option>
          <option value="pro">Pro</option>
          <option value="enterprise">Enterprise</option>
        </select>
        <button class="btn btn-green" onclick="upgradeUser()">Upgrade</button>
        <button class="btn btn-red btn-sm" onclick="disableUser()">Disable User</button>
      </div>
    </div>

    <!-- USERS TABLE -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">üë• All Users</div>
        <button class="btn btn-gray btn-sm" onclick="loadUsers()">üîÑ Refresh</button>
      </div>
      <div id="usersTable"><div class="loading">Loading users...</div></div>
    </div>

  </div>
</div>

<script>
const API = "http://127.0.0.1:8000";
let adminCredentials = null;

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
function doAdminLogin() {
  const u = document.getElementById("adminUser").value.trim();
  const p = document.getElementById("adminPass").value.trim();
  if (!u || !p) { document.getElementById("loginErr").textContent = "Fill in both fields."; return; }
  adminCredentials = btoa(u + ":" + p);
  // Test credentials
  fetch(`${API}/shadow-admin/stats`, {
    headers: { "Authorization": `Basic ${adminCredentials}` }
  }).then(res => {
    if (res.ok) {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("mainPanel").classList.remove("hidden");
      loadStats();
      loadUsers();
    } else {
      document.getElementById("loginErr").textContent = "Wrong credentials.";
      adminCredentials = null;
    }
  }).catch(() => {
    document.getElementById("loginErr").textContent = "Cannot connect to server.";
  });
}

function doLogout() {
  adminCredentials = null;
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("mainPanel").classList.add("hidden");
  document.getElementById("adminUser").value = "";
  document.getElementById("adminPass").value = "";
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
async function loadStats() {
  const res = await fetch(`${API}/shadow-admin/stats`, {
    headers: { "Authorization": `Basic ${adminCredentials}` }
  });
  const data = await res.json();
  document.getElementById("statsGrid").innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Users</div>
      <div class="stat-value">${data.total_users}</div>
    </div>
    <div class="stat-card blue">
      <div class="stat-label">Total Debates</div>
      <div class="stat-value">${data.total_debates}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Free Users</div>
      <div class="stat-value">${data.plan_breakdown.free}</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-label">Pro Users</div>
      <div class="stat-value">${data.plan_breakdown.pro}</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">Enterprise</div>
      <div class="stat-value">${data.plan_breakdown.enterprise}</div>
    </div>
  `;
}

// ‚îÄ‚îÄ USERS TABLE ‚îÄ‚îÄ
async function loadUsers() {
  const res = await fetch(`${API}/shadow-admin/users`, {
    headers: { "Authorization": `Basic ${adminCredentials}` }
  });
  const users = await res.json();

  if (!users.length) {
    document.getElementById("usersTable").innerHTML = `<div class="loading">No users found.</div>`;
    return;
  }

  let html = `<table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Plan</th>
        <th>Status</th>
        <th>Debates Today</th>
        <th>Total Debates</th>
        <th>Joined</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>`;

  users.forEach(u => {
    const planClass = `plan-${u.plan}`;
    const status = u.is_active
      ? `<span class="status-active">Active</span>`
      : `<span class="status-disabled">Disabled</span>`;
    const joined = u.created_at ? u.created_at.split(".")[0].replace("T", " ") : "-";

    html += `<tr>
      <td>${u.id}</td>
      <td><strong>${u.username || "-"}</strong></td>
      <td style="color:#94a3b8;">${u.email || "-"}</td>
      <td><span class="plan-badge ${planClass}">${u.plan.toUpperCase()}</span></td>
      <td>${status}</td>
      <td>${u.debates_today}</td>
      <td>${u.total_debates}</td>
      <td style="color:#64748b;font-size:12px;">${joined}</td>
      <td>
        <div class="actions">
          <button class="btn btn-green btn-sm" onclick="quickUpgrade('${u.username}','pro')">‚Üí Pro</button>
          <button class="btn btn-gray btn-sm" onclick="quickUpgrade('${u.username}','free')">‚Üí Free</button>
        </div>
      </td>
    </tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById("usersTable").innerHTML = html;
}

// ‚îÄ‚îÄ UPGRADE ‚îÄ‚îÄ
async function upgradeUser() {
  const username = document.getElementById("upgradeUsername").value.trim();
  const plan     = document.getElementById("upgradePlan").value;
  if (!username) { showToast("Enter a username.", "error"); return; }
  const res = await fetch(`${API}/shadow-admin/upgrade?username=${username}&plan=${plan}`, {
    method: "POST",
    headers: { "Authorization": `Basic ${adminCredentials}` }
  });
  const data = await res.json();
  if (res.ok) {
    showToast(data.message, "success");
    loadUsers(); loadStats();
  } else {
    showToast(data.detail || "Error.", "error");
  }
}

async function quickUpgrade(username, plan) {
  const res = await fetch(`${API}/shadow-admin/upgrade?username=${username}&plan=${plan}`, {
    method: "POST",
    headers: { "Authorization": `Basic ${adminCredentials}` }
  });
  const data = await res.json();
  if (res.ok) { showToast(data.message, "success"); loadUsers(); loadStats(); }
  else { showToast(data.detail || "Error.", "error"); }
}

// ‚îÄ‚îÄ DISABLE ‚îÄ‚îÄ
async function disableUser() {
  const username = document.getElementById("upgradeUsername").value.trim();
  if (!username) { showToast("Enter a username.", "error"); return; }
  if (!confirm(`Disable user "${username}"?`)) return;
  const res = await fetch(`${API}/shadow-admin/disable?username=${username}`, {
    method: "POST",
    headers: { "Authorization": `Basic ${adminCredentials}` }
  });
  const data = await res.json();
  if (res.ok) { showToast(data.message, "success"); loadUsers(); }
  else { showToast(data.detail || "Error.", "error"); }
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg, type) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => { t.className = "toast"; }, 3500);
}

// Enter key on login
document.addEventListener("keydown", e => {
  if (e.key === "Enter" && adminCredentials === null) doAdminLogin();
});
</script>
</body>
</html>
